{% extends 'core.html' %}

{% block content %}

<style>
  /* Cambiar el cursor al pasar el mouse sobre el checkbox */
  .form-check-input:hover {
    cursor: pointer;
  }
</style>

<div class="container">
  <div class="row justify-content-center align-items-center">
    <div class="card o-hidden border-0 shadow-lg">
      <div class="text-center">
        <br>
        <h1>Venta</h1>
      </div>
      <form method="post" enctype="multipart/form-data" action="">
        {% csrf_token %}
        <div class="form-group">
          <label for="proveedor">Cliente</label>
          <select class="form-control" id="cliente" name="cliente">
            <option value="">Seleccione un cliente</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="fecha">Fecha</label>
          <input type="date" class="form-control" id="fecha" name="fecha">
        </div>

        <div class="form-group">
          <label for="productos">Productos</label>
          <table class="table table-bordered" id="tablaProductos">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody>
              <!-- Aquí se añadirán las filas dinámicamente -->
            </tbody>
          </table>
          <button type="button" class="btn btn-success" onclick="agregarFila()">Agregar Producto</button>
        </div>

        <div class="form-group">
          <label for="total">Total</label>
          <input type="text" class="form-control" id="total" name="total" value="0" readonly>
        </div>

        <div class="form-group">
          <input id="botonEnvio" class="btn btn-primary btn-lg" type="submit" value="Guardar" name="botonEnvio">
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Función para agregar una nueva fila de productos
  function agregarFila() {
    var tabla = document.getElementById('tablaProductos').getElementsByTagName('tbody')[0];
    var nuevaFila = tabla.insertRow(); // Insertar nueva fila

    // Insertar celda de Producto (usar un select para buscar productos)
    var celdaProducto = nuevaFila.insertCell(0);
    celdaProducto.innerHTML = `
      <select class="form-control" name="producto[]" onchange="actualizarPrecio(this)">
        <option value="">Seleccione un producto</option>
        {% for producto in productos %}
        <option value="{{ producto.id }}" data-precio="{{ producto.precio_venta }}">{{ producto.nombre }}</option>
        {% endfor %}
      </select>`;

    // Insertar celda de Cantidad
    var celdaCantidad = nuevaFila.insertCell(1);
    celdaCantidad.innerHTML = '<input type="number" step="1.00" class="form-control" name="cantidad[]" value="0" min="0" oninput="calcularSubtotal(this)">';

    // Insertar celda de Precio
    var celdaPrecio = nuevaFila.insertCell(2);
    celdaPrecio.innerHTML = '<input type="number" class="form-control" name="precio[]" value="0" min="0" step="0.01" readonly>';

    // Insertar celda de Subtotal
    var celdaSubtotal = nuevaFila.insertCell(3);
    celdaSubtotal.innerHTML = '<input type="text" class="form-control" name="subtotal[]" value="0" readonly>';

    // Insertar celda de Eliminar
    var celdaEliminar = nuevaFila.insertCell(4);
    celdaEliminar.innerHTML = '<button type="button" class="btn btn-danger" onclick="eliminarFila(this)">Eliminar</button>';
  }

  // Función para eliminar una fila
  function eliminarFila(boton) {
    var fila = boton.parentNode.parentNode;
    fila.parentNode.removeChild(fila);
    calcularTotal(); // Recalcular total después de eliminar una fila
  }

  // Función para actualizar el precio cuando se selecciona un producto
  function actualizarPrecio(selectProducto) {
    var fila = selectProducto.parentNode.parentNode;
    var precio = selectProducto.options[selectProducto.selectedIndex].getAttribute('data-precio');
    var inputPrecio = fila.querySelector('input[name="precio[]"]');

    if (precio) {
      inputPrecio.value = parseFloat(precio).toFixed(2); // Asignar precio al campo de precio
    } else {
      inputPrecio.value = 0;
    }

    calcularSubtotal(fila.querySelector('input[name="cantidad[]"]')); // Calcular subtotal
  }

  // Función para calcular el subtotal de una fila
  function calcularSubtotal(elemento) {
    var fila = elemento.parentNode.parentNode;
    var cantidad = fila.querySelector('input[name="cantidad[]"]').value;
    var precio = fila.querySelector('input[name="precio[]"]').value;
    var subtotal = fila.querySelector('input[name="subtotal[]"]');

    subtotal.value = (cantidad * precio).toFixed(2); // Calcular y asignar subtotal
    calcularTotal(); // Recalcular total después de actualizar el subtotal
  }

  // Función para calcular el total de la compra
  function calcularTotal() {
    var total = 0;
    var subtotales = document.querySelectorAll('input[name="subtotal[]"]');

    subtotales.forEach(function (subtotal) {
      total += parseFloat(subtotal.value) || 0;
    });

    document.getElementById('total').value = total.toFixed(2);
  }
</script>


{% endblock %}